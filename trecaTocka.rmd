---
title: "Projekt"
author: "Matej Čubek"
date: "17/12/2020"
output:
html_document:
df_print: paged
pdf_document: default
subtitle: 'Analiza uspješnosti većih naspram manjih fondova (veća imovina pod upravljanje naspram manja).'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

Učitavanje paketa.
```{r echo=T, error=FALSE, warning=FALSE, message=FALSE}
library(dplyr)
```

Učitavanje podataka.
```{r}
mutual_funds <- read.csv("./Dataset/mutual_funds.csv")
dim(mutual_funds)
```

Ispis svih atributa.
```{r}
names(mutual_funds)
```

Selekcija bitnih atributa.
Veličinu fonda odrediti ćemo atributom net_assets ili imovinom pod upravljanje.
```{r}
mutual_funds_bySize <- select(mutual_funds, c("fund_name", "net_assets", "category", "net_annual_expense_ratio_fund", "net_annual_expense_ratio_category", "fund_return_10years", "category_return_10years", "morningstar_rating"))
dim(mutual_funds_bySize)
```

Kratka statistika varijabli
```{r}
summary(mutual_funds_bySize)

sapply(mutual_funds_bySize, class)
```

Morningstar rating pretvaramo u kategorijsku varijablu
Ispistati ćemo i izbaciti sve fondove sa morningstar ratingom od 0 jer on predstavlja nepostojeću vrijednost, a morningstar rating koristimo kao jednu od dvije metrike za uspješnost.
```{r}
mutual_funds_bySize$morningstar_rating <- as.factor(mutual_funds_bySize$morningstar_rating)
mutual_funds_bySize[mutual_funds_bySize$morningstar_rating == 0,]
mutual_funds_bySize <- subset(mutual_funds_bySize, mutual_funds_bySize$morningstar_rating != 0)
```

Ispisati ćempo sve fondove bez net_assets vrijednosti i ukloniti ih iz dataseta.
Net_assets nam treba za odredivajne velicine fonda.
```{r}
mutual_funds_bySize[is.na(mutual_funds_bySize$net_assets),]
mutual_funds_bySize <- subset(mutual_funds_bySize, !is.na(mutual_funds_bySize$net_assets))
```

Pregled podataka fondova.
Net fund return u 10 godina i net category return u 10 godina koristimo ra računanje uspješnosti fonda.
Uspješnost definiramo kao fund return kao njihovu razliku.
```{r, fig.width = 14, fig.height=5}
hist(mutual_funds_bySize$fund_return_10years, main = 'Fund return in 10 years [%]', xlab = 'Return', ylab = 'Frequency')
hist(mutual_funds_bySize$category_return_10years, main = 'Category return in 10 year s[%]', xlab = 'Return', ylab = 'Frequency')

mutual_funds_bySize <- mutual_funds_bySize %>% mutate(success = fund_return_10years - category_return_10years)

hist(mutual_funds_bySize$success,probability = T, main = 'Rate of success [%]', xlab = 'Success', ylab = 'Frequency', breaks = 20)
lines(density(mutual_funds_bySize$success),col = 2)
```

Analiza kategorijskog podatka morningstar rating.
```{r, fig.width = 14, fig.height=5}
barplot(summary(mutual_funds_bySize$morningstar_rating), main='Morningstar rating')
```

Podjela na velike i male fondove gdje granicu izmedu njihove veličine definiramo kao medijan varijable net_assets.
```{r, fig.width = 14, fig.height=5}
median <- median(mutual_funds_bySize$net_assets)
mutual_funds_large <- mutual_funds_bySize[mutual_funds_bySize$net_assets > median,]
mutual_funds_small <- mutual_funds_bySize[mutual_funds_bySize$net_assets <= median,]
summary(mutual_funds_large)

summary(mutual_funds_small)
```

Razlika srednjih vrijednosti velikih i malih fondova.
Uspoređujemo izračunatu srednju vrijednost vrijednost ocjene i morning star vrijednosta.
```{r}
cat('Prosječni izračunati uspjeh većih fondova iznosi  ', mean(mutual_funds_large$success),'\n')
cat('Prosječni izračunati uspjeh manjih fondova iznosi  ', mean(mutual_funds_small$success),'\n')
require(modeest)
cat('Prosječni morningstar rating većih fondova iznosi  ', mfv(mutual_funds_large$morningstar_rating),'\n')
cat('Prosječni morningstar rating manjih fondova iznosi  ', mfv(mutual_funds_small$morningstar_rating),'\n')
```

Grafučki prikaz uspješnosti kroz izračunatu vrijednost za male i velike fondove kroz boxplot.
```{r}
boxplot(mutual_funds_large$success, mutual_funds_small$success,
        names = c('Large fund success','Small fund success'),
        main='Boxplot of large and small fund success rate')
```

Histogram za uspjeh velikih i malih fondova.
```{r}
hist(mutual_funds_large$success,
     breaks = 20,
     main='Histogram of rate of success of large funds',
     xlab='Success rate')

hist(mutual_funds_small$success,
     main='Histogram of rate of success of small funds',
     xlab='Success rate')
```

QQ Plot uspješnosti velikih i malih fondova.
```{r}
qqnorm(mutual_funds_large$success, pch = 1, frame = FALSE,main='Large funds')
qqline(mutual_funds_large$success, col = "steelblue", lwd = 2)

qqnorm(mutual_funds_small$success, pch = 1, frame = FALSE,main='Small funds')
qqline(mutual_funds_small$success, col = "steelblue", lwd = 2)
```
Zbog velike količine podataka pretpostavljamo normalnost.


Provjera normalnosti.
```{r}
library(nortest)
lillie.test(mutual_funds_bySize$success)
```
Test nam ukazuje da odbacujemo H0 -> pretpostavku da je normalno distribuirano.


Izbaciti
--------------------------------------------------------------
Varijance velikih i malih fondova
```{r}
var(mutual_funds_large$success)
var(mutual_funds_small$success)
```

Usporedba jednakosti varijanci.
```{r}
var.test(mutual_funds_large$success, mutual_funds_small$success)
```
Odbacujemo pretpostavku H0 -> da su varijance jednake.


Koristimo t test s razlicitim varijancama.
```{r}
t.test(mutual_funds_large$success, mutual_funds_small$success, alt = "greater", var.equal = FALSE)
```
Test nam govori da su veći fondovi prosječno uspješniji.

--------------------------------------------------------------

```{r}
wilcox.test(mutual_funds_large$success, mutual_funds_small$success, alternative = "greater")
```
Test nam govori da su veći fondovi prosječno uspješniji.

Usporedba po morningstar ratingu.

Tablica svih fondova po morningstar ocjeni.
```{r}
levels(mutual_funds_bySize$morningstar_rating)
table(mutual_funds_bySize$morningstar_rating)
```

Tablica malih i velikih fondova po morningstar ocjeni.
```{r}
table(mutual_funds_large$morningstar_rating)
table(mutual_funds_small$morningstar_rating)
```

Isti podaci prikazani barplotom.
```{r, fig.width = 14, fig.height=5}
barplot(summary(mutual_funds_large$morningstar_rating),main='Morningstar rating for large funds')
barplot(summary(mutual_funds_small$morningstar_rating),main='Morningstar rating for small funds')
```

Tablica sa postocima.
```{r}
large_rating <- table(mutual_funds_large$morningstar_rating)
small_rating <-table(mutual_funds_small$morningstar_rating)
round(prop.table(large_rating),digits=3)
round(prop.table(small_rating),digits=3)
```
Barchart po postocima.
```{r, fig.width = 14, fig.height=5}
barplot(prop.table(large_rating), xlab='Rating',ylab='Frequency',main="Morningstar rating distribution of large funds",ylim=range(pretty(c(0,prop.table(large_rating)))))

barplot(prop.table(small_rating), xlab='Rating',ylab='Frequency',main="Morningstar rating distribution of small funds",ylim=range(pretty(c(0,prop.table(small_rating)))))
```

Test proporcija
```{r}
large_high_ratings <- large_rating[["4"]][1] + large_rating[["5"]][1]
large_collective <- large_rating[["1"]][1] + large_rating[["2"]][1] + large_rating[["3"]][1] + large_rating[["4"]][1] + large_rating[["5"]][1]
large_high_ratings
large_collective

small_high_ratings <- small_rating[["4"]][1] + small_rating[["5"]][1]
small_collective <- small_rating[["1"]][1] + small_rating[["2"]][1] + small_rating[["3"]][1] + small_rating[["4"]][1] + small_rating[["5"]][1]
small_high_ratings
small_collective

rating_proportions <- c(large_high_ratings,small_high_ratings)
rating_sum <- c(large_collective,small_collective)
prop.test(rating_proportions,rating_sum, alt="greater")
```
Odbacujemo H0 -> hipotezu da su proporcije visoko rangiranih jednake kod većih i manjih fondova.
Veći fondovi imaju veću proporciju visoko rangiranih fondova nego mali.


Pokusaj s linearnom regresijom,

Grafički prikaz odnosa uspješnosti računate na prvi način i veličine fonda.
```{r}
plot(mutual_funds_bySize$net_assets, mutual_funds_bySize$success)
```

Linearni model metrike uspjeha i veličine fonda
```{r}
fit.size <- lm(success~net_assets, data=mutual_funds_bySize)

plot(mutual_funds_bySize$net_assets, mutual_funds_bySize$success)
lines(mutual_funds_bySize$net_assets, fit.size$fitted.values, col='red')
```
Nagib pravca pokazuje blagu ovisnost o veličini fonda na njegov uspjeh. Kako bi se dobiveni model analizirao potrebno je provjeriti da pretpostavke narušene. Pritom su najbitnije pretpostavke o regresorima  i o rezidualima.


Normalnost reziduala moguće je provjeriti grafički, pomoću kvantil-kvantil plota (usporedbom s linijom normalne razdiobe), te statistički pomoću Kolmogorov-Smirnovljevog testa.
```{r res}

selected.model <- fit.size

plot(selected.model$residuals) #gledajuci reziduale na ovaj nacin tesko je suditi o normalnosti

#histogram je vrlo interpretativan
hist((selected.model$residuals))
hist(rstandard(selected.model))

#q-q plot reziduala s linijom normalne distribucije
qqnorm(rstandard(selected.model))
qqline(rstandard(selected.model))

plot(selected.model$fitted.values,selected.model$residuals) #reziduale je dobro prikazati u ovisnosti o procjenama modela

#KS test na normalnost
ks.test(rstandard(fit.size),'pnorm')

require(nortest)
lillie.test(rstandard(fit.size))

```
Reziduali nisu normalno distribuirani i model nam nije uspio.

Not applicable
--------------------------------------------------------------

Analiza modela
```{r analiza procijenjenih modela}

summary(fit.size)

```